name: Build & Test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
jobs:
  build:
    name: Build and test infc
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-14]
        toolchain:
          - nightly
    runs-on: ${{ matrix.os }}
    steps:
      - name: Setup Rust
        uses: actions/checkout@v4.1.3
      - name: Cache external binaries
        uses: actions/cache@v4
        id: cache-binaries
        with:
          path: external/
          key: ${{ runner.os }}-binaries-v4
          restore-keys: |
            ${{ runner.os }}-binaries-
      - name: Download binaries (Linux)
        if: runner.os == 'Linux' && steps.cache-binaries.outputs.cache-hit != 'true'
        run: |
          mkdir -p external/bin/linux external/lib/linux
          # Download and extract inf-llc
          curl -L "https://storage.googleapis.com/external_binaries/linux/bin/inf-llc.zip" -o /tmp/inf-llc.zip
          unzip -o /tmp/inf-llc.zip -d external/bin/linux/
          # Download and extract rust-lld
          curl -L "https://storage.googleapis.com/external_binaries/linux/bin/rust-lld.zip" -o /tmp/rust-lld.zip
          unzip -o /tmp/rust-lld.zip -d external/bin/linux/
          # Download and extract libLLVM
          curl -L "https://storage.googleapis.com/external_binaries/linux/lib/libLLVM.so.21.1-rust-1.94.zip" -o /tmp/libLLVM.zip
          unzip -o /tmp/libLLVM.zip -d external/lib/linux/
          # Make executables
          chmod +x external/bin/linux/inf-llc external/bin/linux/rust-lld
      - name: Download binaries (macOS)
        if: runner.os == 'macOS' && steps.cache-binaries.outputs.cache-hit != 'true'
        run: |
          mkdir -p external/bin/macos
          # Download and extract inf-llc
          curl -L "https://storage.googleapis.com/external_binaries/macos/bin/inf-llc.zip" -o /tmp/inf-llc.zip
          unzip -o /tmp/inf-llc.zip -d external/bin/macos/
          # Download and extract rust-lld
          curl -L "https://storage.googleapis.com/external_binaries/macos/bin/rust-lld.zip" -o /tmp/rust-lld.zip
          unzip -o /tmp/rust-lld.zip -d external/bin/macos/
          # Make executables
          chmod +x external/bin/macos/inf-llc external/bin/macos/rust-lld
      - name: Download binaries (Windows)
        if: runner.os == 'Windows' && steps.cache-binaries.outputs.cache-hit != 'true'
        run: |
          New-Item -ItemType Directory -Force -Path external\bin\windows
          New-Item -ItemType Directory -Force -Path external\llvm\windows
          New-Item -ItemType Directory -Force -Path external\lib\windows
          
          # Download and extract inf-llc.exe
          Invoke-WebRequest -Uri "https://storage.googleapis.com/external_binaries/windows/bin/inf-llc.zip" -OutFile "$env:TEMP\inf-llc.zip"
          Expand-Archive -Path "$env:TEMP\inf-llc.zip" -DestinationPath external\bin\windows\ -Force
          
          # Download and extract rust-lld.exe
          Invoke-WebRequest -Uri "https://storage.googleapis.com/external_binaries/windows/bin/rust-lld.zip" -OutFile "$env:TEMP\rust-lld.zip"
          Expand-Archive -Path "$env:TEMP\rust-lld.zip" -DestinationPath external\bin\windows\ -Force
          
          # Download complete LLVM 21.1.1 (MSYS2 build with all targets)
          Write-Output "Downloading complete LLVM 21.1.1 from GCS..."
          Invoke-WebRequest -Uri "https://storage.googleapis.com/external_binaries/windows/llvm/llvm-21-msys2-ucrt64-full-targets.zip" -OutFile "$env:TEMP\llvm-full.zip"
          Write-Output "Extracting LLVM to external\llvm\windows..."
          Expand-Archive -Path "$env:TEMP\llvm-full.zip" -DestinationPath external\llvm\windows\ -Force
          
          # Download XML-related import/static libraries
          Write-Output "Downloading XML import libs..."
          Invoke-WebRequest -Uri "https://storage.googleapis.com/external_binaries/windows/build/libxml2.dll.a" -OutFile "external\lib\windows\libxml2.dll.a"
          Invoke-WebRequest -Uri "https://storage.googleapis.com/external_binaries/windows/build/libxml2.a" -OutFile "external\lib\windows\libxml2.a"
          Invoke-WebRequest -Uri "https://storage.googleapis.com/external_binaries/windows/build/libiconv.dll.a" -OutFile "external\lib\windows\libiconv.dll.a"
          Invoke-WebRequest -Uri "https://storage.googleapis.com/external_binaries/windows/build/libz.a" -OutFile "external\lib\windows\libz.a"
          Invoke-WebRequest -Uri "https://storage.googleapis.com/external_binaries/windows/build/libzstd.dll.a" -OutFile "external\lib\windows\libzstd.dll.a"
          Invoke-WebRequest -Uri "https://storage.googleapis.com/external_binaries/windows/build/libffi.dll.a" -OutFile "external\lib\windows\libffi.dll.a"
          
          # Download runtime DLLs
          Write-Output "Downloading XML runtime DLLs..."
          Invoke-WebRequest -Uri "https://storage.googleapis.com/external_binaries/windows/build/libxml2-16.dll" -OutFile "external\bin\libxml2-16.dll"
          Invoke-WebRequest -Uri "https://storage.googleapis.com/external_binaries/windows/build/libiconv-2.dll" -OutFile "external\bin\libiconv-2.dll"
          Invoke-WebRequest -Uri "https://storage.googleapis.com/external_binaries/windows/build/zlib1.dll" -OutFile "external\bin\zlib1.dll"
          
          # Copy LLVM DLL to external\bin for runtime
          Copy-Item "external\llvm\windows\bin\libLLVM-21.dll" "external\bin\libLLVM-21.dll" -Force
          
          Write-Output "All Windows binaries downloaded and cached"
      - name: Update Rust
        run: |
          rustup update ${{ matrix.toolchain }}
          rustup default ${{ matrix.toolchain }}
          rustup component add llvm-tools-preview
      - name: Add MinGW target (Windows)
        if: runner.os == 'Windows'
        run: |
          rustup target add x86_64-pc-windows-gnu
          rustup default ${{ matrix.toolchain }}-x86_64-pc-windows-gnu
      - name: Install MinGW (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # Install MSYS2 for MinGW toolchain
          choco install msys2 -y --no-progress
          
          # Install MinGW UCRT64 toolchain (matches LLVM build)
          C:\tools\msys64\usr\bin\bash.exe -lc "pacman -Syu --noconfirm"
          C:\tools\msys64\usr\bin\bash.exe -lc "pacman -S --noconfirm mingw-w64-ucrt-x86_64-toolchain"
          
          # Add MinGW to PATH
          Add-Content -Path $env:GITHUB_PATH -Value "C:\tools\msys64\ucrt64\bin"
          
          Write-Output "Installed MSYS2 UCRT64 MinGW toolchain"
          Write-Output "Installed MSYS2 UCRT64 MinGW toolchain with zstd"
      - name: Install LLVM (Linux)
        if: runner.os == 'Linux'
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 21
          sudo apt-get install -y llvm-21-dev libpolly-21-dev
      - name: Install LLVM (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install llvm@21 || brew install llvm
      - name: Setup LLVM (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $llvmDir = "$PWD\external\llvm\windows"
          $llvmBin = Join-Path $llvmDir "bin"
          $dstLib = Join-Path $llvmDir "lib"
          $cachedLibDir = "external\lib\windows"

          # Copy libraries into LLVM lib directory
          Copy-Item (Join-Path $cachedLibDir "libxml2.dll.a") (Join-Path $dstLib "libxml2s.lib") -Force
          Copy-Item (Join-Path $cachedLibDir "libxml2.dll.a") (Join-Path $dstLib "libxml2.dll.a") -Force
          Copy-Item (Join-Path $cachedLibDir "libxml2.a") (Join-Path $dstLib "libxml2.a") -Force
          Copy-Item (Join-Path $cachedLibDir "libiconv.dll.a") (Join-Path $dstLib "libiconv.dll.a") -Force
          Copy-Item (Join-Path $cachedLibDir "libz.a") (Join-Path $dstLib "libz.a") -Force
          Copy-Item (Join-Path $cachedLibDir "libzstd.dll.a") (Join-Path $dstLib "libzstd.dll.a") -Force
          Copy-Item (Join-Path $cachedLibDir "libffi.dll.a") (Join-Path $dstLib "libffi.dll.a") -Force

          # Set environment variables
          Add-Content -Path $env:GITHUB_ENV -Value "LLVM_SYS_211_PREFIX=$llvmDir"
          Add-Content -Path $env:GITHUB_ENV -Value "PATH=$PWD\external\bin;$llvmBin;$env:PATH"
          Add-Content -Path $env:GITHUB_ENV -Value "LIB=$dstLib;$env:LIB"
      - name: Set LLVM Prefix (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          echo "LLVM_SYS_211_PREFIX=/usr/lib/llvm-21" >> $GITHUB_ENV
      - name: Set LLVM Prefix (macOS)
        if: runner.os == 'macOS'
        run: |
          LLVM_PREFIX=$(brew --prefix llvm@21 2>/dev/null || brew --prefix llvm)
          echo "LLVM_SYS_211_PREFIX=$LLVM_PREFIX" >> $GITHUB_ENV
      - name: Install clippy nightly
        run: rustup component add clippy-preview
      - name: Build
        if: runner.os != 'Windows'
        run: cargo build --verbose
      - name: Build (Windows MinGW)
        if: runner.os == 'Windows'
        run: cargo build --verbose --target x86_64-pc-windows-gnu
      - name: Verify vendored LLVM
        run: |
          file external/lib/linux/libLLVM.so.21.1-rust-1.94.0-nightly || true
          file target/debug/lib/libLLVM.so.21.1-rust-1.94.0-nightly || true
        if: runner.os == 'Linux'
      - name: Test
        if: runner.os != 'Windows'
        run: cargo test --verbose
      - name: Test (Windows MinGW)
        if: runner.os == 'Windows'
        run: cargo test --verbose --target x86_64-pc-windows-gnu
      - name: Clippy
        if: runner.os != 'Windows'
        run: cargo clippy --verbose -- -D warnings
      - name: Clippy (Windows MinGW)
        if: runner.os == 'Windows'
        run: cargo clippy --verbose --target x86_64-pc-windows-gnu -- -D warnings
      - name: Install Cargo audit
        run: cargo install cargo-audit
      - name: Audit
        run: cargo audit
